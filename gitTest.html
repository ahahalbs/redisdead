<html>
    <head>
        <title>grail</title>
        <script src="enable-threads.js"></script>
        <script src="./dist/aframe-master.min.js"></script>
        <script crossorigin src="maxiInstruments.v.0.7.1.js"></script>
        <script src="bassline.js"></script>
        <script>
            let animationStarted = false;
            let bassSynth;
            let sampler; 

            // make clear that the origin is on mimicproject
            var origin = "https://mimicproject.com/libs";
            // pass the origin in when loading your instruments
            const instruments = new MaxiInstruments(origin);

            instruments.loadModules().then(()=> {

                bassSynth = instruments.addSynth();
                bassSynth.setOsc(2);

                bassSynth.setParams([
                    ["oscFn",3],
                    ["lfoOscFn",0],
                    ["gain",0.5],
                    ["pan",0.5],
                    ["attack",375],
                    ["decay",1500],
                    ["sustain",1],
                    ["release",1245],
                    ["lfoFrequency",10],
                    ["lfoPitchMod",0],
                    ["lfoFilterMod",720],
                    ["lfoAmpMod",0.36],
                    ["adsrPitchMod",0],
                    ["cutoff",2644.8],
                    ["reverbMix",0.06],
                    ["roomSize",0],
                    ["delay",14994.000000000002],
                    ["delayMix",0.09],
                    ["frequency",440],
                    ["frequency2",440],
                ]);

                sampler = instruments.addSampler();
                sampler.loadSample("study3.4backing.mp3", 0);
                sampler.setParam("rate_0", 1);
                sampler.setParam("pan_0", 0.5);
                sampler.setParam("gain_0", 1);

                let drums = [
                    {p:0, s:0, v:127}, 
                ];

                instruments.playPause();
                sampler.setSequence(drums,4);

            }).catch((err)=> {
                console.log("error", err);
            });

            const playSomething=()=>{
                instruments.rewind();
                instruments.playPause();
                //Set the sequences to the instruments
                instruments.setTempo(129);

            }

            // AFRAME component
            AFRAME.registerComponent('controller-listener', {
                init: function () {
                    this.container = document.createElement('a-entity');
                    this.el.sceneEl.appendChild(this.container);

                    this.cylinder = document.createElement('a-cylinder');
                    this.cylinder.setAttribute('radius', '0.005');
                    this.cylinder.setAttribute('material', { color: 'white', transparent: true, opacity: 0.5 });
                    this.cylinder.setAttribute('rotation', { x: 90, y: 0, z: 0 });

                    this.container.appendChild(this.cylinder);

                    this.triggerdown = false;

                    this.el.addEventListener('buttondown', (event) => {
                        const tilesEntity = document.getElementById('tilesEntity');

                        if (!animationStarted) {
                            tilesEntity.setAttribute('animation', 'property: position; from:0 0 0; to: 0 0 2480; dur: 288377; easing: linear');
                            playSomething();
                            animationStarted = true;
                        }
                    });

                    document.addEventListener('keydown', (event) => {
                        if (event.key == 'p' && animationStarted == false) {
                            const tilesEntity = document.getElementById('tilesEntity');
                            tilesEntity.setAttribute('animation', 'property: position; from:0 0 0; to: 0 0 2480; dur: 288377; easing: linear');
                            playSomething();
                            animationStarted = true;
                        }
                    });

                    this.el.addEventListener('triggerdown', (event) => {
                        const color = this.el.id === 'leftHand' ? '#FD3A69' : '#FECD1A';
                        this.cylinder.setAttribute('material', { color: color, transparent: false, opacity: 1 });
                        this.triggerdown = true;
                        const intersectedEls = this.el.components.raycaster.intersectedEls;

                        if (intersectedEls.length > 0) {
                            let noteValue = intersectedEls[0].dataset.basslineP;
                            let noteLength = intersectedEls[0].dataset.basslineL * 116;

                            if (intersectedEls[0].getAttribute('id') === 'bassLeft' && this.el.id === 'leftHand') {
                                bassSynth.noteon(noteValue);
                                intersectedEls[0].setAttribute("visible", 'false');
                            } else if (intersectedEls[0].getAttribute('id') === 'bassRight' && this.el.id === 'rightHand') {
                                bassSynth.noteon(noteValue);
                                intersectedEls[0].setAttribute("visible", 'false');
                            }

                            setTimeout(() => {
                                bassSynth.noteoff(noteValue);
                            }, noteLength);
                        }

                        setTimeout(() => {
                            this.cylinder.setAttribute('material', { color: 'white' });
                        }, 250);
                    });

                    this.el.addEventListener('loaded', () => {
                        this.updateCylinder();
                    });

                    this.el.setAttribute('raycaster', 'showLine', false);
                },

                tick: function () {
                    this.updateCylinder();
                    // do stuff with triggerdown
                },

                updateCylinder: function () {
                    const raycasterComponent = this.el.components.raycaster;
                    if (raycasterComponent) {
                        const origin = raycasterComponent.raycaster.ray.origin;
                        const direction = raycasterComponent.raycaster.ray.direction.clone();
                        const far = raycasterComponent.data.far;

                        this.cylinder.setAttribute('height', far);

                        const offsetPosition = new THREE.Vector3().copy(direction).multiplyScalar(far / 2);

                        this.container.object3D.position.copy(origin).add(offsetPosition);

                        this.container.object3D.quaternion.setFromUnitVectors(new THREE.Vector3(0, 0, -1), direction);
                    }
                }
            });

            // AFRAME scene onload
            window.addEventListener('DOMContentLoaded', (event) => {
                const sceneEl = document.querySelector('a-scene');
                const tilesEntity = document.getElementById('tilesEntity');

                function populateBlocks() {
                    for (let i = 0; i < bassline.length; i++) {
                        let tile = document.createElement('a-box');
                        tile.dataset.basslineP = bassline[i].p;
                        tile.dataset.basslineL = bassline[i].l;

                        let modifier = 0;

                        if (i % 2 == 0) {
                            tile.setAttribute('material', 'color', '#FD3A69');
                            tile.setAttribute('id', 'bassLeft');
                            if (i >= 120 && i <= 172 && i % 3 == 0 || i >= 476 && i < 533) {
                                modifier = 3;
                            } else if (i > 172 && i < 227 && i % 2 == 0 || i > 365 && i < 424 && i % 2) {
                                modifier = 2;
                            }
                            let x = -1;
                            let y = 0;
                            if (tile.dataset.basslineP == 65) {
                                x = -1;
                                y = 0;
                            } else if (tile.dataset.basslineP == 68) {
                                x = -2;
                                y = 1;
                            } else if (tile.dataset.basslineP == 69) {
                                x = -3;
                                y = 2;
                            } else if (tile.dataset.basslineP == 72) {
                                x = -4;
                                y = 3;
                            } else if (tile.dataset.basslineP == 74) {
                                x = -2;
                                y = 3;
                            } else if (tile.dataset.basslineP > 74) {
                                x = -1;
                                y = 2;
                            } else {
                                x = -1;
                                y = -1;
                            }
                            tile.setAttribute('position', { x: x + modifier, y: y, z: -bassline[i].s - (bassline[i].l / 2) - 7.5 });

                        } else {
                            tile.setAttribute('id', 'bassRight');
                            tile.setAttribute('material', 'color', '#FECD1A');
                            if (i >= 120 && i <= 172 && i % 3 == 0 || i >= 476 && i < 533) {
                                modifier = -3;
                            } else if (i > 172 && i < 227 && i % 2 == 0 || i > 365 && i < 424 && i % 2) {
                                modifier = -2;
                            }
                            let x = 1;
                            let y = 0;
                            if (tile.dataset.basslineP == 65) {
                                x = 1;
                                y = 0;
                            } else if (tile.dataset.basslineP == 68) {
                                x = 2;
                                y = 1;
                            } else if (tile.dataset.basslineP == 69) {
                                x = 3;
                                y = 2;
                            } else if (tile.dataset.basslineP == 72) {
                                x = 4;
                                y = 3;
                            } else if (tile.dataset.basslineP == 74) {
                                x = 2;
                                y = 3;
                            } else if (tile.dataset.basslineP > 74) {
                                x = 1;
                                y = 2;
                            } else {
                                x = 1;
                                y = -1;
                            }
                            tile.setAttribute('position', { x: x + modifier, y: y, z: -bassline[i].s - (bassline[i].l / 2) - 7.5 });
                        }

                        tile.setAttribute('class', 'interactive');
                        tile.setAttribute('width', 0.75);
                        tile.setAttribute("height", 0.75);
                        tile.setAttribute("depth", tile.dataset.basslineL);
                        tile.setAttribute("visible", 'true');
                        tilesEntity.appendChild(tile);
                    }
                }

                if (sceneEl.hasLoaded) {
                    populateBlocks();
                    sceneEl.appendChild(tilesEntity);
                } else {
                    sceneEl.addEventListener('loaded', () => {
                        populateBlocks();
                        sceneEl.appendChild(tilesEntity);
                    });
                }
            });

        </script>
    </head>
    <body>
        <a-scene stats background="color: #120078">
            <a-entity id="rig" position="0 0 0">   
                <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .interactive; far: 10; showLine: false; lineOpacity: 0" controller-listener></a-entity>
                <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .interactive; far: 10; showLine: false; lineOpacity: 0" controller-listener></a-entity>

                <a-box color="#FECD1A" position="0 0.5 -13" width="16" height="4" depth="1" side="double" opacity="0.05"></a-box>
                <a-plane color="#9D0191" position="0 -1.51 -8" width="16" height="1" rotation="-90 0 0" > </a-plane>
                <a-plane color="#9D0191" position="0 -1.51 -6" width="12" height="1" rotation="-90 0 0" > </a-plane>
                <a-plane color="#FECD1A" position="0 -1.51 -4" width="8" height="1" rotation="-90 0 0" > </a-plane>
                <a-plane color="#9D0191" position="0 -1.51 -2" width="4" height="1" rotation="-90 0 0" > </a-plane>
                <a-plane color="#9D0191" position="0 -1.51  0" width="2" height="1" rotation="-90 0 0" > </a-plane>

                <a-camera look-controls wasd-controls-enabled="true" far="24"></a-camera>
            </a-entity>

            <a-entity id="tilesEntity"></a-entity>

        </a-scene>

    </body>
</html>
