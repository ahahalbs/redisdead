<html>
    <head>
        <title>laser test and tiles</title>
        <script src="enable-threads.js"></script>
        <script src="./dist/aframe-master.min.js"></script>
        <script crossorigin src="maxiInstruments.v.0.7.1.js"></script>
        <script src="bassline.js"></script>
        <script src="dualbassline.js"></script>
        <script>
            let backingMidSynth;
            let bassSynth;
            let sampler; 
            
             // make clear that the origin is on mimicproject
                var origin = "https://mimicproject.com/libs";
                // pass the origin in when loading your instruments
                const instruments = new MaxiInstruments(origin);

                instruments.loadModules().then(()=> {
                    let bassSynth;
                    bassSynth = instruments.addSynth();
                    bassSynth.setOsc(2);

                    bassSynth.setParams([
                        ["oscFn",3],
                        ["lfoOscFn",0],
                        ["gain",0.5],
                        ["pan",0.5],
                        ["attack",375],
                        ["decay",1500],
                        ["sustain",1],
                        ["release",1245],
                        ["lfoFrequency",10],
                        ["lfoPitchMod",0],
                        ["lfoFilterMod",720],
                        ["lfoAmpMod",0.36],
                        ["adsrPitchMod",0],
                        ["cutoff",2644.8],
                        ["reverbMix",0.06],
                        ["roomSize",0],
                        ["delay",14994.000000000002],
                        ["delayMix",0.09],
                        ["frequency",440],
                        ["frequency2",440],
                    ]);

                    sampler = instruments.addSampler();
                    sampler.loadSample("study3.2backing.mp3", 0);
//                    sampler.loadSample("DR660SnareLofinice.wav", 1);
//                    sampler.loadSample("TOM-ER-MicroTom2.wav", 2);
                    sampler.setParam("rate_0", 1);
//                    sampler.setParam("rate_1", 1);
//                    sampler.setParam("rate_2", 1);
//                    sampler.setParam("rate_3", 1);
//                    sampler.setParam("rate_4", 1);
                    sampler.setParam("pan_0", 0.5);
//                    sampler.setParam("pan_1", 0.5);
//                    sampler.setParam("pan_2", 0.5);
//                    sampler.setParam("pan_3", 0.5);
//                    sampler.setParam("pan_4", 0.5);
                    sampler.setParam("gain_0", 1);
//                    sampler.setParam("gain_1", 1);
//                    sampler.setParam("gain_2", 1);    
//                    sampler.setParam("gain_3", 1);    
//                    sampler.setParam("gain_4", 1);  
                    //Make your own drum sequence, pitch refers to sample index
                    //24 Steps per beat

                    //let drums = [
//                         {p:1, s:0, v:0},
//                         {p:0, s:1, v:0},
//                         {p:0, s:2, v:0},
//                         {p:0, s:3, v:00}
//                         {p:0, s:4, v:0},
//                         {p:0, s:5, v:0},
//                         {p:0, s:6, v:0},
//                         {p:0, s:7, v:0},
//                         {p:0, s:8, v:0},
//                         {p:0, s:9, v:0},
//                         {p:0, s:10, v:0},
//                         {p:0, s:11, v:0},
//                         {p:0, s:12, v:0},
//                         {p:0, s:13, v:0},
//                         {p:0, s:14, v:0},
//                         {p:0, s:15, v:0},,
  //   
                    //];
                    
//                     let bassSynthSeq = [
//                         {s:0, l:2, p:53},
//                         {s:3, l:1, p:57},
//                         {s:4, l:2, p:56},
//                         {s:6, l:2, p:53},
//                         {s:32, l:2, p:53},
//                         {s:35, l:1, p:57},
//                         {s:36, l:2, p:56},
//                         {s:38, l:2, p:52},
//                     ];
              

 
                                          let drums = [
                        {p:0, s:0, v:127},
//                        {p:0, s:4, v:127},
//                        {p:0, s:8, v:127},
//                        {p:0, s:12, v:127},
//                        {p:0, s:14, v:127}, 
                     ];
                    instruments.playPause();
                    sampler.setSequence(drums,4);
                    //bassSynth.setSequence(bassSynthSeq, 4);
                    bassSynth.setSequence(dualbassline, 4);
                                    }).catch((err)=> {
                    console.log("error", err);
                });
            
            const playSomething=()=>{
                    instruments.rewind();
                    instruments.playPause();
                    //Set the sequences to the instruments
                    instruments.setTempo(129);
                    

                    //instruments.playPause();
                    
                    //bassSynth.setLoop(141,4);
                    //sampler.setLoop(16,4);


            }

            window.addEventListener('DOMContentLoaded', (event) => {

                const scene = document.querySelector('a-scene');
                const tilesEntity = document.getElementById('tilesEntity');
                let animationStarted = false;

  
                function populateBlocks(){
                    //number of total 16th notes in level
                    const sequenceLength = 1204;
                    const tileSize = 1;
                    let tiles =[];
                    let positions =[];
                    
    //                 let tileHeight = 1;
                    for(let i = 0; i <= sequenceLength ; i++){
                        let tile = document.createElement('a-box');
                        if(i%2==0){
                         tile.setAttribute('id', 'bassLeft'); 
                         tile.setAttribute('material', 'color', '#FD3A69');    
                        } else{
                         tile.setAttribute('id', 'bassRight'); 
                         tile.setAttribute('material', 'color', '#FECD1A');       
                        }
                      	tile.setAttribute('class', 'interactive');
                      	let calc = Math.round(Math.abs((255/16) *(i%16)));
                    	let rgbString = `rgb(${calc}, ${calc}, ${calc})`;
                    	//tile.setAttribute('material', 'color', rgbString);
                    	tile.setAttribute('width', 1);
                    	tile.setAttribute("height", 1);
                    	tile.setAttribute("depth", 1);
                      	//tile.setAttribute('position', positions[i]);
                        tile.setAttribute('position', {x: -1, y:0, z:-i*2});
                        tile.setAttribute("visible", 'true');
                        tiles.push({ent: tile, index: i, note: 0, length: 0});
                        tilesEntity.appendChild(tile);
                    }
                  

                    
                  	
                  
                }
               	populateBlocks();
              
              
                scene.appendChild(tilesEntity);
  
//                 let tileHeight = 1;
//                for(let i = 0; i <= sequenceLength ; i++){
//                    
//                    //platform.setAttribute('material', {color: rgbString, transparent: 'true', opacity: '0.5'});
//
//                    //tile.setAttribute('position', {x: 0, y: -2, z: -i*tileSize});
//                  
//                  	if(i % 4 == 0){
//                      //let tileHeight = 2;
//                    let tile = document.createElement('a-box');
//                      
//                    tile.setAttribute('position', {x: -1, y: -1, z: -i*tileSize});
//                    tile.setAttribute('id', 'kick');
//                    tile.setAttribute('class', 'interactive');  
//                    let calc = Math.round(Math.abs((255/16) *(i%16)));
//                    let rgbString = `rgb(${calc}, ${calc}, ${calc})`;
//                    tile.setAttribute('material', 'color', rgbString);
//                    tile.setAttribute('width', tileSize);
//                    tile.setAttribute("height", tileSize);
//                    tile.setAttribute("depth", tileSize);
//                    tilesEntity.appendChild(tile);
//
//                    }
//                    if (i % 3 == 0) {
//                    let tileHeight = 3;
//                    let tile = document.createElement('a-box');
//                    tile.setAttribute('position', {x: 1, y: 1, z: -i*tileSize});
//                    //tileHeight = 3;  
//                    tile.setAttribute('geometry', { primitive: 'box' });
//                    tile.setAttribute('class', 'interactive');
//                    tile.setAttribute('id', 'snare');
//                    let calc = Math.round(Math.abs((255/16) *(i%16)));
//                    let rgbString = `rgb(${calc}, ${calc}, ${calc})`;
//                    tile.setAttribute('material', 'color', rgbString);
//                    tile.setAttribute('width', tileSize);
//                    tile.setAttribute("height", tileSize);
//                    tile.setAttribute("depth", tileSize);
//                    tilesEntity.appendChild(tile);
//                  
//                    }
//                  
//                } 
                
                //scene.appendChild(tilesEntity);
              

                AFRAME.registerComponent('controller-listener', {
                    init: function () {
                        // cylinder parent
                        this.container = document.createElement('a-entity');
                        this.el.sceneEl.appendChild(this.container);

                        // cylinder
                        this.cylinder = document.createElement('a-cylinder');
                        this.cylinder.setAttribute('radius', '0.005');  // Cylinder radius
                        this.cylinder.setAttribute('material', {color: 'white', transparent: true, opacity: 0.5});
                        this.cylinder.setAttribute('rotation', {x: 90, y: 0, z: 0});

                        // add to parent
                        this.container.appendChild(this.cylinder);

                        //trigger state
                        this.triggerdown = false;

                        this.el.addEventListener('buttondown', (event) => {
                            const tilesEntity = document.getElementById('tilesEntity');

                            if (!animationStarted) {
                                tilesEntity.setAttribute('animation', 'property: position; from:0 0 0; to: 0 0 2256; dur: 273494; easing: linear');
                                playSomething();
                                animationStarted = true;
                            }
                        });
                         //start the step sequencer
                          document.addEventListener('keydown', (event) => {
                              if (event.key == 'p' && animationStarted == false){
                                  tilesEntity.setAttribute('animation', 'property: position; from:0 0 0; to: 0 0 2256; dur: 273494; easing: linear');
                                  playSomething();
                                  
                                  
                                  animationStarted = true;
                              }
                          });
						    this.el.addEventListener('triggerdown', (event) => {
                            const color = this.el.id === 'leftHand' ? '#FD3A69' : '#FECD1A';
                            this.cylinder.setAttribute('material', {color: color, transparent: false, opacity: 1});

                            this.triggerdown = true;

                            const intersectedEls = this.el.components.raycaster.intersectedEls;

                            if (intersectedEls.length > 0) {
                                if (intersectedEls[0].getAttribute('id') === 'bassLeft' && this.el.id === 'leftHand') {
                                    intersectedEls[0].setAttribute("visible", 'false');
                                    sampler.noteon(0,127);
                                } else if (intersectedEls[0].getAttribute('id') === 'bassRight' && this.el.id === 'rightHand') {
                                    intersectedEls[0].setAttribute("visible", 'false');
                                    sampler.noteon(1,127);
                                }
                            }  

                            setTimeout(() => {
                                this.cylinder.setAttribute('material', {color: 'white'});
                            }, 250);
                        });

                        // wait for the raycaster component to be loaded before update
                        this.el.addEventListener('loaded', () => {
                            this.updateCylinder();
                        });

                        // hide ray line
                        this.el.setAttribute('raycaster', 'showLine', false);
                    },

                    tick: function () {
                        // update the cylinder
                        this.updateCylinder();
                       //do stuff with triggerdown
                    },

                    updateCylinder: function () {
                        const raycasterComponent = this.el.components.raycaster;
                        if (raycasterComponent) {
                            const origin = raycasterComponent.raycaster.ray.origin;
                            const direction = raycasterComponent.raycaster.ray.direction.clone();
                            const far = raycasterComponent.data.far;

                            // match cylinder's height to raycaster's far 
                            this.cylinder.setAttribute('height', far);

                            // calculate the offset position
                            const offsetPosition = new THREE.Vector3().copy(direction).multiplyScalar(far / 2);

                            // match cylinders parent to raycaster's origin and adjust for offset
                            this.container.object3D.position.copy(origin).add(offsetPosition);

                            // Set rotation to match the ray direction
                            this.container.object3D.quaternion.setFromUnitVectors(new THREE.Vector3(0, 0, -1), direction);
                        }
                    }
                });

            });           
        </script>
    </head>
    <body>
        <a-scene stats background="color: #120078">
            <a-entity id="rig" position="0 0 0">   
                <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .interactive; far: 10; showLine: false; lineOpacity: 0" controller-listener></a-entity>
                <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .interactive; far: 10; showLine: false; lineOpacity: 0" controller-listener></a-entity>

                <a-box color="#FECD1A" position="0 0.5 -13" width="16" height="4" depth="1" side="double" opacity="0.05"></a-box>
                <a-plane color="#9D0191" position="0 -1.51 -8" width="16" height="1" rotation="-90 0 0" > </a-plane>
                <a-plane color="#9D0191" position="0 -1.51 -6" width="12" height="1" rotation="-90 0 0" > </a-plane>
                <a-plane color="#FECD1A" position="0 -1.51 -4" width="8" height="1" rotation="-90 0 0" > </a-plane>
                <a-plane color="#9D0191" position="0 -1.51 -2" width="4" height="1" rotation="-90 0 0" > </a-plane>
                <a-plane color="#9D0191" position="0 -1.51  0" width="2" height="1" rotation="-90 0 0" > </a-plane>

                <a-camera look-controls wasd-controls-enabled="true" far="24"></a-camera>
            </a-entity>

            <a-entity id="tilesEntity"></a-entity>


            <!--             <a-box id="target" class="interactive" position="-1 0.5 -3" rotation="0 0 0" color="blue"></a-box> -->
            <!--             <a-box id="greenBox" class="interactive" position="1 0.5 -3" rotation="0 0 0" color="green"></a-box> -->
        </a-scene>
        <script>




        </script>


    </body>
</html>
